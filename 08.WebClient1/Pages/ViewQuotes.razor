@page "/view-quotes"
@using _01.Contracts.Models
@using System.Collections.Generic
@using System.Linq
@inject _08.WebClient1.State.OrderState State
@inject NavigationManager Nav

<h3>Quotations</h3>

@if (State.OrderId == null)
{
    <div class="alert alert-warning">No order in progress. Start with <a href="/create-order">Create Order</a>.</div>
}
else
{

    @if (State.Quotations != null && State.Quotations.Any())
    {
        <div class="mt-3">
            @foreach (var q in State.Quotations)
            {
                <div class="card mb-2">
                    <div class="card-header">
                        Quote #@q.QuoteId - Distributor: @q.Distributor | ETA: @q.EstimatedDays days | Created: @q.CreatedAt.ToString("u")
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead><tr><th>Product</th><th>Unit Price</th><th>Available</th></tr></thead>
                            <tbody>
                                @foreach (var item in q.Items)
                                {
                                    <tr>
                                        <td>@item.ProductId</td>
                                        <td>@item.UnitPrice</td>
                                        <td>@item.Available</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            <button class="btn btn-success" @onclick="GoCompare">Compare & Select</button>
        </div>
    }
    else
    {
        <div class="mt-3"><em>No quotations available yet.</em></div>
    }
}

@code {
    protected override async Task OnInitializedAsync()
    {
        await LoadQuotes();
    }

    private async Task LoadQuotes()
    {
        if (State.OrderId == null) return;

            var distributors = new[] { "TechWorld", "ElectroCom", "GadgetCentral" };
        var quotes = new List<QuotationResultDto>();
        var quoteId = 1;
        foreach (var dist in distributors)
        {

            var q = new QuotationResultDto
            {
                QuoteId = quoteId,
                OrderId = State.OrderId.Value,
                Distributor = dist,
                EstimatedDays = dist == "TechWorld" ? 3 : dist == "ElectroCom" ? 4 : 5,
                CreatedAt = DateTime.UtcNow,
                Items = State.OrderItems.Select((it, idx) => new QuotationItemResultDto
                {
                    QuotationItemId = idx + 1,
                    QuotationId = quoteId,
                    ProductId = it.ProductId,
                    UnitPrice = 100 + it.ProductId + (dist == "ElectroCom" ? -5 : 0),
                    Available = 10
                }).ToList()
            };
            quotes.Add(q);
            quoteId++;
        }

        State.Quotations = quotes;
        await Task.CompletedTask;
    }

    private void GoCompare()
    {
        Nav.NavigateTo($"/review-selection");
    }
}